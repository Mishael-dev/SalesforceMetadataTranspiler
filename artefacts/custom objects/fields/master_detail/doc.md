# Field Documentation: MasterDetail

This document breaks down the Salesforce **Master-Detail Custom Field XML** and separates the metadata into categories based on how the transpiler, LLM, and UI will interact with them.

---

Stored in `master_detail__c.field-meta.xml`.

## 1. The Outer Container

This wraps the field definition in Salesforce Source Format (SFDX).

```xml
<?xml version="1.0" encoding="UTF-8"?>
<CustomField xmlns="http://soap.sforce.com/2006/04/metadata">
    <!-- Field content goes here -->
</CustomField>
```

---

## 2. Core Field Configuration (LLM Generated)

These are the primary intent fields. The LLM must decide these to define the business logic and identity of the Master-Detail field.

```xml
<fullName>master_detail__c</fullName>
<label>master_detail</label>
<description>master detail description</description>
<inlineHelpText>master-detail-help-text</inlineHelpText>
<referenceTo>Account</referenceTo>
<relationshipLabel>Kitchen Sinks</relationshipLabel>
<relationshipName>Kitchen_Sinks</relationshipName>
<relationshipOrder>0</relationshipOrder>
<reparentableMasterDetail>true</reparentableMasterDetail>
<writeRequiresMasterRead>false</writeRequiresMasterRead>
```

---

## 3. Supporting Features (React Flow UI)

These fields are not generated by the LLM by default. They are provided as defaults by the Zod schema but are displayed in the React Flow interface in case the user wants to toggle specific platform behaviors.

```xml
<trackHistory>false</trackHistory>
```

---

## 4. Others (Transpiler Injected)

These fields are considered platform-required metadata and are automatically added by the transpiler. They ensure the XML is valid for the Salesforce Metadata API but do not require input from the LLM or the end-user.

```xml
<type>MasterDetail</type>
<trackTrending>false</trackTrending>
```

---

## Json Shape

This section represents the core field definition as a JSON object.

```json
{
  "type": "MasterDetail",
  "label": "master_detail",
  "fullName": "master_detail__c",
  "description": "master detail description",
  "inlineHelpText": "master-detail-help-text",
  "referenceTo": "Account",
  "relationshipLabel": "Kitchen Sinks",
  "relationshipName": "Kitchen_Sinks",
  "relationshipOrder": 0,
  "reparentableMasterDetail": true,
  "writeRequiresMasterRead": false
}
```

---

## 5. Validation Rules

This section documents the validation rules applied to **Master-Detail** fields at each validation layer in the transpiler pipeline.

### Level 1: Structural Validation (The Shape)

Ensures the JSON matches the Master-Detail field schema.

* `type` must be exactly `MasterDetail`.
* `label` must be a non-empty string.
* `fullName` must be a valid Salesforce custom field API name ending in `__c`.
* `referenceTo` must be a valid Salesforce object API name.
* `relationshipLabel` and `relationshipName` must be non-empty strings.
* `relationshipOrder` must be a non-negative integer.
* `reparentableMasterDetail` and `writeRequiresMasterRead` must be booleans.
* `description` and `inlineHelpText` must be strings.

---

### Level 2: Logical Validation (The Context)

Ensures internal consistency and field dependencies.

* `relationshipName` must be unique per object.
* `relationshipOrder` defines the display order in roll-up summaries; must match UI expectations.
* `reparentableMasterDetail` true allows child records to be reassigned to different parents.
* `writeRequiresMasterRead` true ensures child record write access respects master record read permissions.

---

### Level 3: Platform Constraints (The Linter)

Enforces hard Salesforce platform rules that are not reliably expressible in Zod schemas and must be checked via custom logic.

* `fullName` (API name, excluding `__c`) must not exceed **40 characters**.
* `label` must not exceed **40 characters**.
* `relationshipName` must be unique per object and not exceed Salesforce limits.
* Master-Detail fields cannot exist if the object already has more than **2 master-detail relationships**.
* `referenceTo` must be a standard or custom object supporting master-detail relationships.
* Cannot mark Master-Detail as `unique` or `externalId`.

---

### Level 4: State & Conflict Validation (The Pre-Flight)

An optional runtime validation layer that inspects the target Salesforce org before deployment.

* Verify that no existing field with the same `fullName` already exists on the target object.
* Prevent changes to `type` (MasterDetail â†’ other types is illegal).
* Prevent changes to `referenceTo` if child records exist.
* Ensure `relationshipName` and `relationshipLabel` do not conflict with existing relationships.
* Validate that the target object is **not managed-package locked**.
* Detect namespace collisions in namespaced orgs.

Failures at this level should be surfaced as **pre-deployment conflicts**, not schema errors.

---

## 6. Summary Table for Transpiler Logic

| XML Tag                      | JSON Key                 | Source | Default Value      |
| ---------------------------- | ------------------------ | ------ | ------------------ |
| `<fullName>`                 | fullName                 | LLM    | Derived from Label |
| `<label>`                    | label                    | LLM    | N/A                |
| `<description>`              | description              | LLM    | Empty String       |
| `<inlineHelpText>`           | inlineHelpText           | LLM    | Empty String       |
| `<referenceTo>`              | referenceTo              | LLM    | None               |
| `<relationshipLabel>`        | relationshipLabel        | LLM    | None               |
| `<relationshipName>`         | relationshipName         | LLM    | None               |
| `<relationshipOrder>`        | relationshipOrder        | LLM    | 0                  |
| `<reparentableMasterDetail>` | reparentableMasterDetail | LLM    | false              |
| `<writeRequiresMasterRead>`  | writeRequiresMasterRead  | LLM    | false              |
| `<trackHistory>`             | trackHistory             | UI     | false              |
| `<type>`                     | type                     | System | MasterDetail       |
| `<trackTrending>`            | N/A                      | System | false              |
